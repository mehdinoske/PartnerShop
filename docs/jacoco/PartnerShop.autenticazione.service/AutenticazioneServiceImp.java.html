<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AutenticazioneServiceImp.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PartnerShop</a> &gt; <a href="index.source.html" class="el_package">PartnerShop.autenticazione.service</a> &gt; <span class="el_source">AutenticazioneServiceImp.java</span></div><h1>AutenticazioneServiceImp.java</h1><pre class="source lang-java linenums">package PartnerShop.autenticazione.service;

import PartnerShop.Exceptions.MyServletException;
import PartnerShop.model.dao.CarrelloDAO;
import PartnerShop.model.dao.ClienteDAO;
import PartnerShop.model.dao.UtenteRegistratoDAO;
import PartnerShop.model.entity.Amministratore;
import PartnerShop.model.entity.Cliente;
import PartnerShop.model.entity.UtenteRegistrato;

import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.regex.Pattern;

/**
 *  implementa la classe che esplicita i metodi definiti nell'interfaccia di autenticazione
 */
public class AutenticazioneServiceImp implements AutenticazioneService{

<span class="fc" id="L20">    private UtenteRegistratoDAO utDB =null;</span>
<span class="fc" id="L21">    private String usernameReg = &quot;^[a-zA-Z0-9\\-_]{1,20}$&quot;;</span>


<span class="fc" id="L24">    public AutenticazioneServiceImp(){</span>
<span class="fc" id="L25">        utDB = new UtenteRegistratoDAO();</span>
<span class="fc" id="L26">    }</span>

<span class="fc" id="L28">    public AutenticazioneServiceImp(UtenteRegistratoDAO utDB){</span>
<span class="fc" id="L29">        this.utDB = utDB;</span>
<span class="fc" id="L30">    }</span>

    /**
     * @param username - dell'utente
     * @param password - stringa convertita attraverso sha1
     * @return un utente registrato
     */
    @Override
    public UtenteRegistrato login(String username, String password) {

<span class="fc" id="L40">        UtenteRegistrato ut = null;</span>

        try {
<span class="pc bpc" id="L43" title="2 of 4 branches missed.">            if (username != null &amp;&amp; password != null) {</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">                if(username.matches(usernameReg)) {</span>
<span class="fc" id="L45">                    ut = utDB.doRetrieveByUsernamePass(username, password);</span>
                }else
                {
<span class="fc" id="L48">                    throw new MyServletException(&quot;errore parametri registrazione&quot;);</span>
                }
            }
<span class="fc bfc" id="L51" title="All 2 branches covered.">            if (ut == null) {</span>
<span class="fc" id="L52">                throw new IOException(&quot;Errore utente null&quot;);</span>
            }
<span class="fc" id="L54">        }catch(IOException e ){</span>
<span class="fc" id="L55">            e.printStackTrace();</span>
        }
<span class="fc" id="L57">        catch (MyServletException e){</span>
<span class="fc" id="L58">            e.printStackTrace();</span>
<span class="fc" id="L59">        }</span>
<span class="fc bfc" id="L60" title="All 4 branches covered.">        if(ut!=null &amp;&amp; ut.getTipo()==0) {</span>
<span class="fc" id="L61">            CarrelloDAO car = new CarrelloDAO();</span>
<span class="fc" id="L62">            int id_carrello = car.doRetrieveIdCarrelloByEmailCliente(ut.getEmail());</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">            if(id_carrello==0)</span>
<span class="nc" id="L64">                car.doCreateCarrello(ut.getEmail());</span>
<span class="fc" id="L65">            id_carrello = car.doRetrieveIdCarrelloByEmailCliente(ut.getEmail());</span>
<span class="fc" id="L66">            ut.setId_Carrello(id_carrello);</span>
        }
<span class="fc" id="L68">        return ut;</span>
    }

    /**
     * @param username inserita dall'utente
     * @param password inserita dall'utente
     * @return l'admin se username e password sono nel database
     *
     */
    @Override
    public Amministratore verificaAdmin(String username, String password) {

<span class="fc" id="L80">         utDB = new UtenteRegistratoDAO();</span>
<span class="fc" id="L81">         Amministratore amm = new Amministratore();</span>
        try {
<span class="pc bpc" id="L83" title="2 of 4 branches missed.">            if (username != null &amp;&amp; password != null) {</span>
<span class="fc" id="L84">                amm = utDB.doRetrieveAdmin(username,password);</span>
            }
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">            if (amm == null) {</span>
<span class="fc" id="L87">                throw new IOException(&quot;Errore admin null&quot;);</span>
            }
<span class="fc" id="L89">        }catch(IOException e ){</span>
<span class="fc" id="L90">            e.printStackTrace();</span>
<span class="nc" id="L91">        }</span>
<span class="fc" id="L92">        return amm;</span>
    }

    @Override
    public boolean logout(HttpSession sessione) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if(sessione.getAttribute(&quot;utente&quot;)!=null){</span>
<span class="nc" id="L98">            sessione.removeAttribute(&quot;utente&quot;);</span>
<span class="nc" id="L99">            sessione.removeAttribute(&quot;Carrello&quot;);</span>
<span class="nc" id="L100">            sessione.removeAttribute(&quot;ordini&quot;);</span>
<span class="nc" id="L101">            sessione.removeAttribute(&quot;cliente&quot;);</span>
<span class="nc" id="L102">            return true;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        }else if(sessione.getAttribute(&quot;admin&quot;)!=null){</span>
<span class="nc" id="L104">            sessione.removeAttribute(&quot;admin&quot;);</span>
<span class="nc" id="L105">            return true;</span>
        }
<span class="nc" id="L107">       return false;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>